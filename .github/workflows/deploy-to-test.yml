name: Deploy to TEST Environment

# Manual trigger for TEST deployment using fabric-cicd.
# Resumes capacities before deployment and suspends after (cost optimization).
on:
  workflow_dispatch:
    inputs:
      run_unit_tests:
        description: 'Run unit tests after deployment'
        type: boolean
        default: true
      run_workspace_setup:
        description: 'Run workspace setup notebook (first deployment only)'
        type: boolean
        default: false
      skip_capacity_suspend:
        description: 'Skip capacity suspend (leave running for debugging)'
        type: boolean
        default: false

env:
  PYTHON_VERSION: '3.12'

jobs:
  deploy-to-test:
    name: Deploy to TEST
    runs-on: windows-latest

    # Common environment variables for all steps
    env:
      AZURE_CLIENT_ID: ${{ secrets.SPN_CLIENT_ID }}
      AZURE_CLIENT_SECRET: ${{ secrets.SPN_CLIENT_SECRET }}
      AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
      AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      TEST_DATASTORES_WORKSPACE_ID: ${{ vars.TEST_DATASTORES_WORKSPACE_ID }}
      TEST_PROCESSING_WORKSPACE_ID: ${{ vars.TEST_PROCESSING_WORKSPACE_ID }}
      TEST_CONSUMPTION_WORKSPACE_ID: ${{ vars.TEST_CONSUMPTION_WORKSPACE_ID }}
      GITHUB_ACTIONS: true

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: pip install -r config/requirements.txt && pip install -e config/

      - name: Resume TEST capacities
        run: |
          python config/scripts/manage_capacity.py `
            --environment TEST --action resume --wait

      - name: Deploy all workspaces to TEST
        run: |
          python config/scripts/deploy_with_fabric_cicd.py `
            --environment TEST --all-workspaces

      - name: Run workspace setup
        if: ${{ inputs.run_workspace_setup }}
        run: |
          python config/scripts/run_fabric_notebook.py `
            --workspace-id ${{ vars.TEST_PROCESSING_WORKSPACE_ID }} `
            --notebook-id ${{ vars.TEST_SETUP_NOTEBOOK_ID }}

      - name: Run unit tests
        if: ${{ inputs.run_unit_tests }}
        run: |
          python config/scripts/run_fabric_notebook.py `
            --workspace-id ${{ vars.TEST_PROCESSING_WORKSPACE_ID }} `
            --notebook-id ${{ vars.TEST_UNIT_TESTS_NOTEBOOK_ID }}

      - name: Suspend TEST capacities
        if: ${{ always() && !inputs.skip_capacity_suspend }}
        run: |
          python config/scripts/manage_capacity.py `
            --environment TEST --action suspend
