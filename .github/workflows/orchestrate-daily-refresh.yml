name: Orchestrate Daily Refresh

# Scheduled daily refresh of PROD environment.
# Resumes capacities, runs the daily refresh notebook, then suspends capacities (cost optimization).
on:
  schedule:
    - cron: '0 6 * * *'
  workflow_dispatch:

env:
  PYTHON_VERSION: '3.12'

jobs:
  daily-refresh:
    name: Daily Refresh
    runs-on: windows-latest

    # Common environment variables for all steps
    env:
      AZURE_CLIENT_ID: ${{ secrets.SPN_CLIENT_ID }}
      AZURE_CLIENT_SECRET: ${{ secrets.SPN_CLIENT_SECRET }}
      AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
      AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      PROD_PROCESSING_WORKSPACE_ID: ${{ vars.PROD_PROCESSING_WORKSPACE_ID }}
      GITHUB_ACTIONS: true

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: pip install -r config/requirements.txt

      - name: Resume PROD capacities
        run: |
          python config/scripts/manage_capacity.py `
            --environment PROD --action resume --wait

      - name: Run daily refresh notebook
        run: |
          python config/scripts/run_fabric_notebook.py `
            --workspace-id ${{ vars.PROD_PROCESSING_WORKSPACE_ID }} `
            --notebook-id ${{ vars.PROD_DAILY_REFRESH_NOTEBOOK_ID }}

      - name: Suspend PROD capacities
        if: ${{ always() }}
        run: |
          python config/scripts/manage_capacity.py `
            --environment PROD --action suspend
